{% extends 'analyzer/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <style>
       body {
    font-family: 'Vazirmatn', Tahoma, sans-serif !important;
    direction: rtl;
    color: #333;
    background-color: #f4f7f9;
    background-image: repeating-linear-gradient(45deg, #eaf0f4 25%, transparent 25%, transparent 75%, #eaf0f4 75%, #eaf0f4),
                      repeating-linear-gradient(-45deg, #eaf0f4 25%, transparent 25%, transparent 75%, #eaf0f4 75%, #eaf0f4);
    background-size: 60px 60px;
  }

        .main-title-container {
            border: 3px solid #008080;
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 2.5rem;
            background-color: #f0f9f8;
        }

        .main-title-container h1 {
            color: #006666;
            font-weight: bold;
            margin: 0;
        }

        .subject-card {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: none;
            color: white;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            padding: 1.5rem;
            border-radius: 15px 50px 15px 15px;
        }

        .subject-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        .submit-btn{
            color: white !important;
        }

        .card-math { background: linear-gradient(#e57373, #c62828); }
        .card-chem { background: linear-gradient(#ba68c8, #7b1fa2); }
        .card-phys { background: linear-gradient(#ffb74d, #f57c00); }
        .card-bio  { background: linear-gradient(#81c784, #388e3c); }

        .subject-card h4 {
            font-weight: bold;
            margin-bottom: 1.5rem;
            padding: 0.5rem 1.5rem;
            border: 2px solid white;
            border-radius: 15px 50px 50px 15px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: white;
        }

        .card-math h4 { background-color: #c62828; }
        .card-chem h4 { background-color: #7b1fa2; }
        .card-phys h4 { background-color: #f57c00; }
        .card-bio h4 { background-color: #388e3c; }


        .subject-card .form-label {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            display: block;
            text-align: right;
            color: white;
            font-weight: 500;
        }

        .subject-card .form-control {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: #333;
            font-weight: 500;
            text-align: center;
        }

        .btn-submit-report {
            background-color: #008080;
            border-color: #008080;
            color: white;
            font-weight: bold;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1.2rem;
            transition: background-color 0.3s ease;
        }
        .btn-submit-report:hover {
            background-color: #006666;
            border-color: #006666;
        }
        .submit-btn-custom:hover {
            color: white;
        }
    </style>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <div class="text-center main-title-container">
        <h1 class="display-5">وارد کردن اطلاعات آزمون</h1>
    </div>

    <form id="exam-form-all-subjects">
        <div class="row">
            <div class="col-lg-3 col-md-6 mb-4 text-center">
                <div class="subject-card card-bio h-100">
                    <h4><i class="fa-solid fa-dna"></i> زیست‌شناسی</h4>
                    <label for="total_bio" class="form-label">تعداد کل سوالات</label>
                    <input type="number" class="form-control mb-3" id="total_bio" min="1" max="1000" placeholder="مثال: 50" required>
                    <label for="correct_bio" class="form-label">تعداد پاسخ صحیح</label>
                    <input type="number" class="form-control mb-3" id="correct_bio" min="0" max="1000" placeholder="مثال: 45" required>
                    <label for="wrong_bio" class="form-label">تعداد پاسخ غلط</label>
                    <input type="number" class="form-control mb-3" id="wrong_bio" min="0" max="1000" placeholder="مثال: 4" required>
                    <label for="study_hours_bio" class="form-label">ساعت مطالعه در هفته</label>
                    <input type="number" class="form-control mb-3" id="study_hours_bio" min="0" max="100" step="0.5" placeholder="مثال: 12" required>
                    <label for="practice_bio" class="form-label">تعداد تست تمرینی در هفته</label>
                    <input type="number" class="form-control" id="practice_bio" min="0" max="5000" placeholder="مثال: 400" required>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-4 text-center">
                <div class="subject-card card-phys h-100">
                    <h4><i class="fa-solid fa-atom"></i> فیزیک</h4>
                    <label for="total_phys" class="form-label">تعداد کل سوالات</label>
                    <input type="number" class="form-control mb-3" id="total_phys" min="1" max="1000" placeholder="مثال: 40" required>
                    <label for="correct_phys" class="form-label">تعداد پاسخ صحیح</label>
                    <input type="number" class="form-control mb-3" id="correct_phys" min="0" max="1000" placeholder="مثال: 32" required>
                    <label for="wrong_phys" class="form-label">تعداد پاسخ غلط</label>
                    <input type="number" class="form-control mb-3" id="wrong_phys" min="0" max="1000" placeholder="مثال: 6" required>
                    <label for="study_hours_phys" class="form-label">ساعت مطالعه در هفته</label>
                    <input type="number" class="form-control mb-3" id="study_hours_phys" min="0" max="100" step="0.5" placeholder="مثال: 9" required>
                    <label for="practice_phys" class="form-label">تعداد تست تمرینی در هفته</label>
                    <input type="number" class="form-control" id="practice_phys" min="0" max="5000" placeholder="مثال: 280" required>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-4 text-center">
                <div class="subject-card card-chem h-100">
                    <h4><i class="fa-solid fa-flask-vial"></i> شیمی</h4>
                    <label for="total_chem" class="form-label">تعداد کل سوالات</label>
                    <input type="number" class="form-control mb-3" id="total_chem" min="1" max="1000" placeholder="مثال: 35" required>
                    <label for="correct_chem" class="form-label">تعداد پاسخ صحیح</label>
                    <input type="number" class="form-control mb-3" id="correct_chem" min="0" max="1000" placeholder="مثال: 30" required>
                    <label for="wrong_chem" class="form-label">تعداد پاسخ غلط</label>
                    <input type="number" class="form-control mb-3" id="wrong_chem" min="0" max="1000" placeholder="مثال: 5" required>
                    <label for="study_hours_chem" class="form-label">ساعت مطالعه در هفته</label>
                    <input type="number" class="form-control mb-3" id="study_hours_chem" min="0" max="100" step="0.5" placeholder="مثال: 8" required>
                    <label for="practice_chem" class="form-label">تعداد تست تمرینی در هفته</label>
                    <input type="number" class="form-control" id="practice_chem" min="0" max="5000" placeholder="مثال: 250" required>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-4 text-center">
                <div class="subject-card card-math h-100">
                    <h4><i class="fa-solid fa-calculator"></i> ریاضی</h4>
                    <label for="total_math" class="form-label">تعداد کل سوالات</label>
                    <input type="number" class="form-control mb-3" id="total_math" min="1" max="1000" placeholder="مثال: 50" required>
                    <label for="correct_math" class="form-label">تعداد پاسخ صحیح</label>
                    <input type="number" class="form-control mb-3" id="correct_math" min="0" max="1000" placeholder="مثال: 40" required>
                    <label for="wrong_math" class="form-label">تعداد پاسخ غلط</label>
                    <input type="number" class="form-control mb-3" id="wrong_math" min="0" max="1000" placeholder="مثال: 8" required>
                    <label for="study_hours_math" class="form-label">ساعت مطالعه در هفته</label>
                    <input type="number" class="form-control mb-3" id="study_hours_math" min="0" max="100" step="0.5" placeholder="مثال: 10.5" required>
                    <label for="practice_math" class="form-label">تعداد تست تمرینی در هفته</label>
                    <input type="number" class="form-control" id="practice_math" min="0" max="5000" placeholder="مثال: 300" required>
                </div>
            </div>
        </div>

        <div class="text-center mt-3 mb-5">
            <button type="submit" id="submit-btn" class="btn btn-submit-report submit-btn submit-btn-custom">
                ثبت اطلاعات و دریافت گزارش
            </button>
        </div>
    </form>

    <div id="notification-area"></div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const subjects = {
        'ریاضی': 'math',
        'شیمی': 'chem',
        'فیزیک': 'phys',
        'زیست‌شناسی': 'bio'
    };

    const form = document.getElementById('exam-form-all-subjects');
    const submitBtn = document.getElementById('submit-btn');

    form.addEventListener('submit', function(event) {
        event.preventDefault();
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> در حال ثبت...';

        const allResultsData = []; // یک آرایه برای نگهداری اطلاعات تمام دروس

        // --- اعتبارسنجی و جمع‌آوری داده‌ها ---
        for (const [subjectName, subjectKey] of Object.entries(subjects)) {
            const totalInput = document.getElementById(`total_${subjectKey}`);
            const correctInput = document.getElementById(`correct_${subjectKey}`);
            const wrongInput = document.getElementById(`wrong_${subjectKey}`);
            const studyHoursInput = document.getElementById(`study_hours_${subjectKey}`);
            const practiceInput = document.getElementById(`practice_${subjectKey}`);

            if (!totalInput.value || !correctInput.value || !wrongInput.value || !studyHoursInput.value || !practiceInput.value) {
                showNotification(`لطفاً تمام فیلدهای درس <strong>${subjectName}</strong> را تکمیل کنید.`, 'danger');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ثبت اطلاعات و دریافت گزارش';
                return;
            }

            const total = parseInt(totalInput.value);
            const correct = parseInt(correctInput.value);
            const wrong = parseInt(wrongInput.value);

            if (correct + wrong > total) {
                showNotification(`در درس <strong>${subjectName}</strong>، مجموع پاسخ‌های صحیح و غلط نمی‌تواند از کل سوالات بیشتر باشد.`, 'danger');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ثبت اطلاعات و دریافت گزارش';
                return;
            }

            // اضافه کردن اطلاعات این درس به آرایه کلی
            allResultsData.push({
                subject: subjectName,
                total: total,
                correct: correct,
                wrong: wrong,
                study_hours: parseFloat(studyHoursInput.value),
                practice: parseInt(practiceInput.value)
            });
        }

        // --- ارسال یک درخواست واحد با تمام داده‌ها ---
        fetch("{% url 'save_all_results' %}", { // استفاده از URL جدید
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(allResultsData) // ارسال کل آرایه
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                showNotification('تمام اطلاعات با موفقیت ثبت شد! در حال انتقال به صفحه گزارش...', 'success');
                setTimeout(() => {
                    window.location.href = "{% url 'generate_report' %}";
                }, 1500);
            } else {
                throw new Error(data.message || 'خطا در پردازش اطلاعات.');
            }
        })
        .catch(error => {
            showNotification(error.message || 'یک خطای ناشناخته در ارتباط با سرور رخ داد.', 'danger');
            submitBtn.disabled = false;
            submitBtn.textContent = 'ثبت اطلاعات و دریافت گزارش';
        });
    });

    function showNotification(message, type = 'success') {
        const notificationArea = document.getElementById('notification-area');
        notificationArea.innerHTML = '';
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        notification.role = 'alert';
        notification.innerHTML = message;
        notificationArea.appendChild(notification);
    }
});
</script>
{% endblock %}